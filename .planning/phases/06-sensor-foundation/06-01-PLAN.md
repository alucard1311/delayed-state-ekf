---
phase: 06-sensor-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/usbl_navigation/CMakeLists.txt
  - src/usbl_navigation/package.xml
  - src/usbl_navigation/config/simulation_params.yaml
  - src/usbl_navigation/config/sensor_noise.yaml
  - src/usbl_navigation/config/ekf_params.yaml
  - src/usbl_navigation/include/usbl_navigation/truth_generator_node.hpp
  - src/usbl_navigation/src/nodes/truth_generator_node.cpp
  - src/usbl_navigation/src/nodes/truth_generator_main.cpp
  - src/usbl_navigation/launch/simulation.launch.py
autonomous: true

must_haves:
  truths:
    - "Truth generator publishes smooth lawnmower trajectory at 100Hz"
    - "Truth path is published at 1Hz for visualization"
    - "Package builds without errors"
  artifacts:
    - path: "src/usbl_navigation/CMakeLists.txt"
      provides: "Package build configuration"
      contains: "find_package(Eigen3"
    - path: "src/usbl_navigation/src/nodes/truth_generator_node.cpp"
      provides: "Lawnmower trajectory generation"
      min_lines: 100
    - path: "src/usbl_navigation/launch/simulation.launch.py"
      provides: "Launch file for simulation"
  key_links:
    - from: "truth_generator_node.cpp"
      to: "/truth/odometry"
      via: "ROS2 publisher at 100Hz"
    - from: "truth_generator_node.cpp"
      to: "/truth/path"
      via: "ROS2 publisher at 1Hz"
---

<objective>
Create the usbl_navigation package foundation with truth generator for controlled USBL navigation testing.

Purpose: Establish the ROS2 package structure and ground truth source that all sensor simulators will consume.
Output: Building package with truth_generator_node publishing lawnmower survey trajectory.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Reference existing v1.0 patterns (but this is standalone package):
@src/auv_ekf/CMakeLists.txt
@src/auv_ekf/package.xml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usbl_navigation package structure</name>
  <files>
    src/usbl_navigation/CMakeLists.txt
    src/usbl_navigation/package.xml
    src/usbl_navigation/config/simulation_params.yaml
    src/usbl_navigation/config/sensor_noise.yaml
    src/usbl_navigation/config/ekf_params.yaml
  </files>
  <action>
    Create ROS2 C++ package 'usbl_navigation' with:

    **CMakeLists.txt:**
    - C++17 standard
    - find_package: rclcpp, std_msgs, sensor_msgs, geometry_msgs, nav_msgs, tf2_ros, tf2_geometry_msgs, Eigen3
    - Include directories: include, ${EIGEN3_INCLUDE_DIR}
    - Add executables for truth_generator_node (later: imu_simulator, dvl_simulator, usbl_simulator, navigation_filter)
    - Install targets for lib, include, config, launch

    **package.xml:**
    - Dependencies: rclcpp, std_msgs, sensor_msgs, geometry_msgs, nav_msgs, tf2_ros, tf2_geometry_msgs
    - Build depend: eigen

    **config/simulation_params.yaml:**
    ```yaml
    truth_generator:
      vehicle_speed: 1.5      # m/s
      survey_depth: 50.0      # meters (NED: positive down)
      line_length: 100.0      # meters
      line_spacing: 10.0      # meters
      num_lines: 5
      turn_radius: 5.0        # meters for smooth turns
      publish_rate: 100.0     # Hz
    ```

    **config/sensor_noise.yaml:**
    ```yaml
    imu:
      gyro_noise_density: 0.001       # rad/s/sqrt(Hz)
      gyro_bias_instability: 0.0001   # rad/s
      accel_noise_density: 0.01       # m/s^2/sqrt(Hz)
      accel_bias_instability: 0.001   # m/s^2
      publish_rate: 100.0             # Hz

    dvl:
      velocity_noise_std: 0.02        # m/s
      scale_factor_error: 0.01        # 1% scale factor
      dropout_probability: 0.05       # 5% random dropouts
      canyon_dropout_start: 120.0     # seconds
      canyon_dropout_end: 150.0       # seconds
      publish_rate: 5.0               # Hz

    usbl:
      range_noise_percent: 0.02       # 2% of range
      min_noise: 0.3                  # minimum noise floor (meters)
      processing_delay: 0.2           # seconds
      dropout_probability: 0.10       # 10%
      outlier_probability: 0.05       # 5%
      outlier_offset: 5.0             # meters
      ship_position: [50.0, 25.0, 0.0]  # NED (surface)
      publish_rate: 0.2               # Hz (5 second period)
    ```

    **config/ekf_params.yaml:** (placeholder for Phase 7)
    ```yaml
    ekf:
      prediction_rate: 100.0
      state_buffer_size: 500
      max_usbl_delay: 3.0
      mahalanobis_threshold: 9.21    # chi-squared 3DOF, 99%

      process_noise:
        position: 0.01
        velocity: 0.1
        orientation: 0.001
        gyro_bias: 0.0001
        accel_bias: 0.001

      measurement_noise:
        usbl_position: 1.0
        dvl_velocity: 0.05
    ```
  </action>
  <verify>colcon build --packages-select usbl_navigation succeeds (even if empty executables)</verify>
  <done>Package structure exists with all config files</done>
</task>

<task type="auto">
  <name>Task 2: Create truth_generator_node with lawnmower trajectory</name>
  <files>
    src/usbl_navigation/include/usbl_navigation/truth_generator_node.hpp
    src/usbl_navigation/src/nodes/truth_generator_node.cpp
    src/usbl_navigation/src/nodes/truth_generator_main.cpp
  </files>
  <action>
    Create truth_generator_node that:

    **Header (truth_generator_node.hpp):**
    - Class TruthGeneratorNode : public rclcpp::Node
    - Publishers: nav_msgs::msg::Odometry (/truth/odometry, 100Hz), nav_msgs::msg::Path (/truth/path, 1Hz)
    - Timer for trajectory update
    - Trajectory state: current position, velocity, heading, mission time
    - Parameters from config

    **Implementation (truth_generator_node.cpp):**

    1. **Lawnmower pattern logic:**
       - Start at origin [0, 0, survey_depth]
       - Drive forward line_length meters
       - Turn 180Â° (smooth circular arc with turn_radius)
       - Move laterally by line_spacing
       - Repeat for num_lines

    2. **State machine for trajectory segments:**
       - STRAIGHT: Move forward at vehicle_speed
       - TURNING: Follow circular arc (quarter turns at each corner)
       - Track segment progress and transition

    3. **Quaternion attitude:**
       - Use Eigen::Quaterniond for orientation
       - Heading from atan2 of velocity direction
       - Convert to geometry_msgs::msg::Quaternion

    4. **Odometry message (100Hz):**
       - header.stamp = current ROS time
       - header.frame_id = "world"
       - child_frame_id = "base_link"
       - pose.pose.position = current NED position
       - pose.pose.orientation = current quaternion
       - twist.twist.linear = velocity in body frame
       - twist.twist.angular = angular velocity

    5. **Path message (1Hz):**
       - Accumulate all poses visited
       - Publish for visualization

    **Critical implementation details:**
    - Use Eigen for all math (Eigen::Vector3d, Eigen::Quaterniond)
    - NED convention: +X North, +Y East, +Z Down
    - Smooth turns using circular interpolation (no discontinuities)
    - Log trajectory progress for debugging

    **Main file (truth_generator_main.cpp):**
    - Standard ROS2 main with spin
  </action>
  <verify>
    ros2 run usbl_navigation truth_generator_node --ros-args --params-file config/simulation_params.yaml
    ros2 topic hz /truth/odometry shows ~100Hz
    ros2 topic echo /truth/odometry shows smooth position updates
  </verify>
  <done>Truth generator publishes smooth lawnmower trajectory at 100Hz</done>
</task>

<task type="auto">
  <name>Task 3: Create basic simulation launch file</name>
  <files>src/usbl_navigation/launch/simulation.launch.py</files>
  <action>
    Create Python launch file that:

    1. **Declares arguments:**
       - enable_canyon_dropout (default: true)
       - output_dir (default: /tmp)

    2. **Loads parameter files:**
       - config/simulation_params.yaml
       - config/sensor_noise.yaml

    3. **Launches truth_generator_node:**
       - output='screen' for visibility
       - Parameters from yaml files

    4. **Placeholder commented sections for future nodes:**
       - # imu_simulator_node (Plan 06-02)
       - # dvl_simulator_node (Plan 06-02)
       - # usbl_simulator_node (Plan 06-03)
       - # navigation_filter_node (Phase 7)
       - # metrics_logger_node (Phase 8)

    Follow the pattern from src/auv_sim/launch/simulation.launch.py
  </action>
  <verify>
    ros2 launch usbl_navigation simulation.launch.py
    ros2 topic list shows /truth/odometry and /truth/path
  </verify>
  <done>Launch file starts truth generator with configurable parameters</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] colcon build --packages-select usbl_navigation succeeds
- [ ] ros2 launch usbl_navigation simulation.launch.py runs without errors
- [ ] ros2 topic hz /truth/odometry shows ~100Hz
- [ ] ros2 topic hz /truth/path shows ~1Hz
- [ ] ros2 topic echo /truth/odometry shows smooth position changes (no jumps)
- [ ] Trajectory follows lawnmower pattern (positions increase, then turn, then lateral shift)
</verification>

<success_criteria>
- All tasks completed
- Package builds without errors
- Truth generator publishes at correct rates
- Lawnmower trajectory is smooth (no discontinuities in position or velocity)
- Config files contain all sensor parameters for later plans
</success_criteria>

<output>
After completion, create `.planning/phases/06-sensor-foundation/06-01-SUMMARY.md`
</output>
