---
phase: 08-demo-visualization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/usbl_navigation/config/rviz_config.rviz
  - src/usbl_navigation/launch/simulation.launch.py
  - src/usbl_navigation/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "RViz displays truth path as blue line"
    - "RViz displays estimate path as orange line"
    - "RViz shows robot pose from TF"
    - "Launch file starts all nodes with configurable parameters"
  artifacts:
    - path: "src/usbl_navigation/config/rviz_config.rviz"
      provides: "Complete RViz visualization configuration"
      min_lines: 50
  key_links:
    - from: "RViz Path display"
      to: "/truth_path and /estimate_path"
      via: "Topic subscription"
    - from: "RViz TF display"
      to: "world -> base_link"
      via: "TF tree subscription"
---

<objective>
Create RViz configuration for navigation visualization and finalize launch file.

Purpose: Enable real-time visualization of truth vs estimate trajectories and robot pose.
Output: RViz config file showing dual paths, complete launch file with all parameters.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-navigation-filter/07-03-SUMMARY.md

@src/usbl_navigation/launch/simulation.launch.py
@src/usbl_navigation/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create path publisher nodes for visualization</name>
  <files>src/usbl_navigation/include/usbl_navigation/path_publisher_node.hpp, src/usbl_navigation/src/nodes/path_publisher_node.cpp, src/usbl_navigation/src/nodes/path_publisher_main.cpp</files>
  <action>
    Create PathPublisherNode that:
    1. Subscribes to an Odometry topic (parameter: input_topic)
    2. Maintains a nav_msgs/Path with accumulated poses (limit to last 1000 points)
    3. Publishes Path on output_topic at 2Hz (for RViz efficiency)
    4. Parameters:
       - input_topic: source odometry topic
       - output_topic: path topic to publish
       - frame_id: frame for path header (default: "world")
       - max_points: maximum path length (default: 1000)

    This single node class will be instantiated twice:
    - Once for truth: input=/truth, output=/truth_path
    - Once for estimate: input=/navigation/odometry, output=/estimate_path

    Use Eigen for position extraction. Follow existing node patterns.
  </action>
  <verify>colcon build --packages-select usbl_navigation succeeds</verify>
  <done>path_publisher_node executable builds</done>
</task>

<task type="auto">
  <name>Task 2: Create RViz configuration file</name>
  <files>src/usbl_navigation/config/rviz_config.rviz</files>
  <action>
    Create RViz configuration with:

    1. **Global Options:**
       - Fixed Frame: world
       - Background Color: dark gray (48, 48, 48)

    2. **Displays:**
       - Grid: 1m cells, 100x100, subtle gray lines
       - TF: Show world and base_link frames, arrow scale 0.5
       - Path (Truth): topic=/truth_path, color blue (0,0,255), line width 0.05
       - Path (Estimate): topic=/estimate_path, color orange (255,165,0), line width 0.05
       - Axes (Robot): linked to base_link frame, length 1.0m

    3. **Camera:**
       - Type: TopDownOrtho (for 2D lawnmower view)
       - Initial position: centered on origin, 100m up

    4. **Window geometry:**
       - Reasonable default size (1200x800)
       - Displays panel visible

    Use standard RViz YAML format. Reference ROS2 Humble RViz defaults.
  </action>
  <verify>cat src/usbl_navigation/config/rviz_config.rviz | head -20 shows valid YAML</verify>
  <done>RViz config file created with path displays and TF</done>
</task>

<task type="auto">
  <name>Task 3: Update launch file and CMakeLists</name>
  <files>src/usbl_navigation/launch/simulation.launch.py, src/usbl_navigation/CMakeLists.txt</files>
  <action>
    1. Update CMakeLists.txt:
       - Add path_publisher_node executable
       - Install config/rviz_config.rviz to share/${PROJECT_NAME}/config

    2. Update launch file:
       - Add two path_publisher_node instances:
         * truth_path_publisher: input=/truth, output=/truth_path
         * estimate_path_publisher: input=/navigation/odometry, output=/estimate_path
       - Add optional rviz launch argument (default: false)
       - If rviz=true, launch rviz2 with config file
       - Add launch argument for scenario selection (nominal, canyon_dropout, high_outlier)
       - Configure DVL canyon dropout based on scenario
       - Configure USBL outlier rate based on scenario:
         * nominal: outlier_probability=0.05
         * canyon_dropout: outlier_probability=0.05, enable_canyon_dropout=true
         * high_outlier: outlier_probability=0.20

    Scenario parameters should modify sensor simulator behavior via ROS2 parameters.
  </action>
  <verify>ros2 launch usbl_navigation simulation.launch.py --show-args | grep -E "rviz|scenario"</verify>
  <done>Launch file has rviz option, scenario selection, path publishers included</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] colcon build --packages-select usbl_navigation succeeds
- [ ] path_publisher_node executable exists
- [ ] rviz_config.rviz installed to share/usbl_navigation/config/
- [ ] Launch file shows rviz and scenario arguments
- [ ] ros2 launch usbl_navigation simulation.launch.py rviz:=true scenario:=nominal (syntax check only)
</verification>

<success_criteria>

- Path publisher node builds and can be launched
- RViz config displays truth and estimate paths in distinct colors
- Launch file supports rviz and scenario parameters
- Ready for scenario testing (Plan 08-03)
</success_criteria>

<output>
After completion, create `.planning/phases/08-demo-visualization/08-02-SUMMARY.md`
</output>
