---
phase: 08-demo-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/usbl_navigation/include/usbl_navigation/metrics_logger_node.hpp
  - src/usbl_navigation/src/nodes/metrics_logger_node.cpp
  - src/usbl_navigation/src/nodes/metrics_logger_main.cpp
  - src/usbl_navigation/scripts/plot_results.py
  - src/usbl_navigation/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "Metrics CSV captures truth, estimate, and error at each timestep"
    - "Sawtooth plot shows position error dropping after USBL fixes"
    - "Trajectory plot shows estimate tracking truth path"
    - "Covariance plot shows error within 3-sigma bounds"
  artifacts:
    - path: "src/usbl_navigation/src/nodes/metrics_logger_node.cpp"
      provides: "CSV logging of navigation metrics"
      min_lines: 100
    - path: "src/usbl_navigation/scripts/plot_results.py"
      provides: "Publication-quality plots from CSV data"
      min_lines: 150
  key_links:
    - from: "metrics_logger_node"
      to: "/truth and /navigation/odometry"
      via: "ROS2 subscriptions with message_filters"
      pattern: "Subscriber.*truth|Subscriber.*odometry"
    - from: "plot_results.py"
      to: "CSV file"
      via: "pandas read_csv"
      pattern: "pd\\.read_csv|pandas"
---

<objective>
Create metrics logging node and Python plotting script for navigation performance analysis.

Purpose: Enable quantitative evaluation of delayed-state EKF with position error, trajectory comparison, and covariance consistency plots.
Output: C++ metrics logger node writing CSV, Python script generating publication-quality plots.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-navigation-filter/07-03-SUMMARY.md

@src/usbl_navigation/CMakeLists.txt
@src/usbl_navigation/launch/simulation.launch.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create metrics_logger_node</name>
  <files>src/usbl_navigation/include/usbl_navigation/metrics_logger_node.hpp, src/usbl_navigation/src/nodes/metrics_logger_node.cpp, src/usbl_navigation/src/nodes/metrics_logger_main.cpp</files>
  <action>
    Create MetricsLoggerNode that:
    1. Subscribes to /truth (nav_msgs/Odometry) and /navigation/odometry (nav_msgs/Odometry)
    2. Uses message_filters::ApproximateTimeSynchronizer to pair messages by timestamp (10ms tolerance)
    3. On synchronized callback:
       - Extract truth position (x,y,z) and estimate position
       - Compute position error: sqrt((x_err)^2 + (y_err)^2 + (z_err)^2)
       - Extract 6x6 pose covariance from estimate (diagonal elements 0,7,14 for x,y,z variance)
       - Write CSV row: timestamp, truth_x, truth_y, truth_z, est_x, est_y, est_z, error_3d, sigma_x, sigma_y, sigma_z
    4. ROS2 parameter: output_file (default: /tmp/navigation_metrics.csv)
    5. Write CSV header on node construction
    6. Flush after each write (don't lose data on shutdown)

    Use Eigen for position extraction. Follow existing node patterns in usbl_navigation.
    DO NOT use TimeSynchronizer (exact) - use ApproximateTimeSynchronizer since truth and estimate have different publish rates.
  </action>
  <verify>colcon build --packages-select usbl_navigation succeeds</verify>
  <done>metrics_logger_node executable builds without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create plot_results.py script</name>
  <files>src/usbl_navigation/scripts/plot_results.py</files>
  <action>
    Create Python script that:
    1. Reads CSV from command-line argument or default path
    2. Generates THREE plots using matplotlib:

    **Plot 1: Position Error Sawtooth (error_sawtooth.png)**
    - X-axis: time (seconds)
    - Y-axis: 3D position error (meters)
    - Title: "Position Error Over Time"
    - Should show sawtooth pattern: error grows during dead reckoning, drops on USBL fix

    **Plot 2: Trajectory Comparison (trajectory.png)**
    - X-axis: East position (meters)
    - Y-axis: North position (meters)
    - Two lines: Truth (blue solid), Estimate (orange dashed)
    - Title: "Trajectory: Truth vs Estimate"
    - Legend in corner
    - Equal aspect ratio (no distortion)

    **Plot 3: Covariance Consistency (covariance_bounds.png)**
    - X-axis: time (seconds)
    - Y-axis: position error (meters)
    - Plot 3-sigma bounds: ±3*sqrt(sigma_x^2 + sigma_y^2 + sigma_z^2)
    - Plot actual error line
    - Title: "Error with 3-sigma Bounds"
    - Shaded region for ±3σ bounds

    3. Print summary statistics: RMSE, max error, final error
    4. Save plots to same directory as input CSV (or --output-dir argument)
    5. Make script executable (add shebang #!/usr/bin/env python3)

    Use pandas for CSV reading, matplotlib for plotting. Publication quality: 300 DPI, proper labels, grid.
  </action>
  <verify>python3 src/usbl_navigation/scripts/plot_results.py --help runs without error</verify>
  <done>Script parses arguments and can generate plots from CSV data</done>
</task>

<task type="auto">
  <name>Task 3: Update CMakeLists.txt and add to launch file</name>
  <files>src/usbl_navigation/CMakeLists.txt, src/usbl_navigation/launch/simulation.launch.py</files>
  <action>
    1. Update CMakeLists.txt:
       - Add metrics_logger_node executable (same pattern as other nodes)
       - Install scripts/plot_results.py to lib/${PROJECT_NAME}

    2. Update launch file:
       - Add metrics_logger_node to launch
       - Add output_file parameter using LaunchConfiguration('output_dir')
       - Construct output path: output_dir + '/navigation_metrics.csv'

    Follow existing patterns in CMakeLists.txt and launch file exactly.
  </action>
  <verify>colcon build --packages-select usbl_navigation && ros2 launch usbl_navigation simulation.launch.py --show-args | grep output_dir</verify>
  <done>metrics_logger_node in launch, output_dir parameter exposed</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] colcon build --packages-select usbl_navigation succeeds
- [ ] metrics_logger_node executable exists in install/
- [ ] plot_results.py is executable and installed
- [ ] Launch file includes metrics_logger_node
- [ ] output_dir launch argument works
</verification>

<success_criteria>

- Metrics logger node builds and runs
- Python plotting script handles CSV input
- Both components added to launch file
- Ready for RViz configuration (Plan 08-02) and scenario testing (Plan 08-03)
</success_criteria>

<output>
After completion, create `.planning/phases/08-demo-visualization/08-01-SUMMARY.md`
</output>
