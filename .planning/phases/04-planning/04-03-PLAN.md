---
phase: 04-planning
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified: [src/auv_sim/launch/full_simulation.launch.py]
autonomous: false

must_haves:
  truths:
    - "Mission executes: IDLE → DIVING → NAVIGATING → SURFACING → COMPLETE"
    - "AUV dives to cruise depth"
    - "AUV navigates toward waypoints"
    - "AUV surfaces after waypoints complete"
    - "Mission state published and visible"
  artifacts:
    - path: "src/auv_sim/launch/full_simulation.launch.py"
      provides: "Updated launch with planner"
      contains: "auv_planner"
  key_links:
    - from: "planner_node"
      to: "/auv/cmd/depth"
      via: "depth command"
    - from: "planner_node"
      to: "/auv/ekf/pose"
      via: "state feedback"
---

<objective>
Integrate planner with simulation and verify autonomous mission execution.

Purpose: Validate complete autonomy stack: planner → control → EKF → simulation.
Output: Working autonomous mission that can be demonstrated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-planning/04-01-SUMMARY.md
@.planning/phases/04-planning/04-02-SUMMARY.md

**Full stack:**
1. Stonefish simulator (physics, sensors)
2. EKF node (state estimation from sensors)
3. Control node (PID controllers)
4. Planner node (state machine, waypoint navigation)

**Topics flow:**
- Sensors → EKF → `/auv/ekf/pose`
- Planner reads `/auv/ekf/pose`
- Planner writes `/auv/cmd/{depth,heading,velocity}`
- Control reads commands, writes `/auv/thruster/*`
- Stonefish reads thruster commands

**Expected behavior:**
1. Start: AUV at surface (depth ~0)
2. DIVING: AUV descends to 3m
3. NAVIGATING: AUV moves to waypoints
4. SURFACING: AUV returns to surface
5. COMPLETE: Mission done
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update full simulation launch to include planner</name>
  <files>src/auv_sim/launch/full_simulation.launch.py</files>
  <action>
Update the full_simulation.launch.py to include the planner node.

Add after control node:

```python
# Planner node
planner_pkg_dir = get_package_share_directory('auv_planner')
planner_mission_file = os.path.join(planner_pkg_dir, 'config', 'mission.yaml')

planner_node = Node(
    package='auv_planner',
    executable='planner_node',
    name='planner_node',
    output='screen',
    parameters=[{
        'mission_file': planner_mission_file,
        'arrival_radius': 1.0,
        'depth_tolerance': 0.5,
        'cruise_velocity': 0.3,
        'cruise_depth': 3.0,
        'surface_depth': 0.5,
        'control_rate': 10.0,
        'auto_start': True,
    }]
)

# Delay planner to let control stabilize
delayed_planner = TimerAction(
    period=2.0,
    actions=[planner_node]
)
```

Add delayed_planner to the LaunchDescription return list.

Also update the imports if needed for get_package_share_directory.
  </action>
  <verify>python3 -c "import sys; sys.path.insert(0, 'src/auv_sim/launch'); exec(open('src/auv_sim/launch/full_simulation.launch.py').read()); print('Syntax OK')"</verify>
  <done>Full simulation launch includes planner node</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete autonomous mission stack: simulator + EKF + control + planner</what-built>
  <how-to-verify>
    1. Build all packages:
       colcon build
       source install/setup.bash

    2. Launch full simulation:
       ros2 launch auv_sim full_simulation.launch.py

    3. In another terminal, monitor mission state:
       source install/setup.bash
       ros2 topic echo /auv/mission/state

    4. Watch the simulation and state topic:
       - IDLE → should quickly transition to DIVING (auto_start=True)
       - DIVING → AUV descends, watch depth in Stonefish or:
         ros2 topic echo /auv/ekf/pose --field pose.pose.position.z
       - NAVIGATING → AUV moves toward waypoints
       - SURFACING → AUV returns to surface
       - COMPLETE → mission finished

    5. Verify state transitions happen:
       - Depth reaches ~3m during DIVING
       - AUV moves in XY during NAVIGATING
       - Depth returns to ~0 during SURFACING

    6. Check planner logs for waypoint progress:
       - "Cruise depth reached"
       - "Reached waypoint WP1"
       - "All waypoints complete"
       - "Surface reached"

    Note: Velocity is limited to ~0.3 m/s, so navigation will be slow.
    Waypoints are at (5,0), (5,5), (0,5) - short distances for testing.
  </how-to-verify>
  <resume-signal>Type "approved" if mission completes all states, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] colcon build succeeds for all packages
- [ ] ros2 launch auv_sim full_simulation.launch.py starts all nodes
- [ ] /auv/mission/state topic publishes state transitions
- [ ] Mission progresses through: IDLE → DIVING → NAVIGATING → SURFACING → COMPLETE
- [ ] Human verified autonomous operation
</verification>

<success_criteria>
- All tasks completed
- Launch file updated with planner
- Mission executes autonomously
- All state transitions observed
- Human approved mission behavior
</success_criteria>

<output>
After completion, create `.planning/phases/04-planning/04-03-SUMMARY.md`
</output>
