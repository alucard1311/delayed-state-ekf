---
phase: 04-planning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/auv_planner/package.xml, src/auv_planner/setup.py, src/auv_planner/auv_planner/__init__.py, src/auv_planner/auv_planner/waypoint_manager.py, src/auv_planner/auv_planner/navigation_utils.py]
autonomous: true

must_haves:
  truths:
    - "Waypoints can be loaded from YAML config"
    - "Heading to waypoint computed correctly"
    - "Distance to waypoint computed correctly"
    - "Waypoint arrival detected within configurable radius"
  artifacts:
    - path: "src/auv_planner/auv_planner/waypoint_manager.py"
      provides: "Waypoint list management"
      contains: "class WaypointManager"
    - path: "src/auv_planner/auv_planner/navigation_utils.py"
      provides: "Navigation math utilities"
      contains: "def compute_heading"
  key_links:
    - from: "waypoint_manager.py"
      to: "navigation_utils.py"
      via: "imports for heading/distance"
      pattern: "from.*navigation_utils import"
---

<objective>
Create Python mission planner package with waypoint management and navigation utilities.

Purpose: Foundation for autonomous mission execution - waypoint tracking and navigation math.
Output: auv_planner package with WaypointManager class and navigation utilities.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Control interface (from Phase 3):**
- `/auv/cmd/depth` (std_msgs/Float64) - depth in meters
- `/auv/cmd/heading` (std_msgs/Float64) - heading in radians
- `/auv/cmd/velocity` (std_msgs/Float64) - velocity in m/s

**EKF interface (from Phase 2):**
- `/auv/ekf/pose` (nav_msgs/Odometry) - filtered state estimate

**Coordinate conventions (from STATE.md):**
- Depth = positive z (NED convention)
- Heading in radians, ZYX Euler
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auv_planner Python package</name>
  <files>src/auv_planner/package.xml, src/auv_planner/setup.py, src/auv_planner/auv_planner/__init__.py</files>
  <action>
Create ROS2 Python package structure:

**package.xml:**
```xml
<?xml version="1.0"?>
<package format="3">
  <name>auv_planner</name>
  <version>0.1.0</version>
  <description>Mission planner and state machine for AUV</description>
  <maintainer email="user@example.com">User</maintainer>
  <license>MIT</license>

  <buildtool_depend>ament_python</buildtool_depend>

  <exec_depend>rclpy</exec_depend>
  <exec_depend>std_msgs</exec_depend>
  <exec_depend>nav_msgs</exec_depend>
  <exec_depend>geometry_msgs</exec_depend>

  <export>
    <build_type>ament_python</build_type>
  </export>
</package>
```

**setup.py:**
```python
from setuptools import setup

package_name = 'auv_planner'

setup(
    name=package_name,
    version='0.1.0',
    packages=[package_name],
    data_files=[
        ('share/ament_index/resource_index/packages', ['resource/' + package_name]),
        ('share/' + package_name, ['package.xml']),
        ('share/' + package_name + '/config', ['config/mission.yaml']),
        ('share/' + package_name + '/launch', ['launch/planner.launch.py']),
    ],
    install_requires=['setuptools'],
    zip_safe=True,
    maintainer='User',
    maintainer_email='user@example.com',
    description='Mission planner and state machine for AUV',
    license='MIT',
    entry_points={
        'console_scripts': [
            'planner_node = auv_planner.planner_node:main',
        ],
    },
)
```

Create directories: src/auv_planner/auv_planner/, src/auv_planner/resource/, src/auv_planner/config/, src/auv_planner/launch/
Create empty resource file: src/auv_planner/resource/auv_planner
Create __init__.py with empty content.
  </action>
  <verify>ls src/auv_planner/package.xml && ls src/auv_planner/setup.py</verify>
  <done>Package structure created, ready for implementation</done>
</task>

<task type="auto">
  <name>Task 2: Implement navigation utilities</name>
  <files>src/auv_planner/auv_planner/navigation_utils.py</files>
  <action>
Create navigation math utilities:

```python
"""Navigation utilities for AUV mission planning."""

import math
from typing import Tuple


def compute_heading(current_x: float, current_y: float,
                    target_x: float, target_y: float) -> float:
    """
    Compute heading from current position to target.

    Args:
        current_x, current_y: Current position in meters
        target_x, target_y: Target position in meters

    Returns:
        Heading in radians [-pi, pi], 0 = North/+X, pi/2 = East/+Y
    """
    dx = target_x - current_x
    dy = target_y - current_y
    return math.atan2(dy, dx)


def compute_distance(current_x: float, current_y: float,
                     target_x: float, target_y: float) -> float:
    """
    Compute Euclidean distance from current position to target.

    Args:
        current_x, current_y: Current position in meters
        target_x, target_y: Target position in meters

    Returns:
        Distance in meters
    """
    dx = target_x - current_x
    dy = target_y - current_y
    return math.sqrt(dx * dx + dy * dy)


def is_at_waypoint(current_x: float, current_y: float, current_depth: float,
                   target_x: float, target_y: float, target_depth: float,
                   xy_radius: float = 1.0, depth_tolerance: float = 0.5) -> bool:
    """
    Check if current position is within arrival radius of waypoint.

    Args:
        current_x, current_y, current_depth: Current position
        target_x, target_y, target_depth: Target waypoint
        xy_radius: Horizontal arrival radius in meters
        depth_tolerance: Vertical tolerance in meters

    Returns:
        True if within arrival radius
    """
    xy_dist = compute_distance(current_x, current_y, target_x, target_y)
    depth_diff = abs(current_depth - target_depth)
    return xy_dist <= xy_radius and depth_diff <= depth_tolerance


def normalize_angle(angle: float) -> float:
    """Normalize angle to [-pi, pi] range."""
    while angle > math.pi:
        angle -= 2.0 * math.pi
    while angle < -math.pi:
        angle += 2.0 * math.pi
    return angle
```

Pure functions, no ROS dependencies. Easy to unit test later.
  </action>
  <verify>python3 -c "from auv_planner.navigation_utils import compute_heading; print(compute_heading(0,0,1,0))" should print 0.0</verify>
  <done>Navigation utilities implemented with heading, distance, arrival detection</done>
</task>

<task type="auto">
  <name>Task 3: Implement waypoint manager</name>
  <files>src/auv_planner/auv_planner/waypoint_manager.py, src/auv_planner/config/mission.yaml</files>
  <action>
Create WaypointManager class:

**waypoint_manager.py:**
```python
"""Waypoint management for AUV missions."""

from dataclasses import dataclass
from typing import List, Optional
import yaml


@dataclass
class Waypoint:
    """Single waypoint with x, y, depth coordinates."""
    x: float
    y: float
    depth: float
    name: str = ""


class WaypointManager:
    """Manages waypoint sequence for missions."""

    def __init__(self):
        self._waypoints: List[Waypoint] = []
        self._current_index: int = 0

    def load_from_yaml(self, yaml_path: str) -> bool:
        """
        Load waypoints from YAML file.

        Expected format:
        waypoints:
          - {x: 5.0, y: 0.0, depth: 3.0, name: "WP1"}
          - {x: 5.0, y: 5.0, depth: 3.0, name: "WP2"}
        """
        try:
            with open(yaml_path, 'r') as f:
                data = yaml.safe_load(f)

            self._waypoints = []
            for wp_data in data.get('waypoints', []):
                wp = Waypoint(
                    x=float(wp_data['x']),
                    y=float(wp_data['y']),
                    depth=float(wp_data['depth']),
                    name=wp_data.get('name', f"WP{len(self._waypoints)}")
                )
                self._waypoints.append(wp)

            self._current_index = 0
            return len(self._waypoints) > 0
        except Exception as e:
            print(f"Error loading waypoints: {e}")
            return False

    def get_current_waypoint(self) -> Optional[Waypoint]:
        """Get current target waypoint, or None if complete."""
        if self._current_index < len(self._waypoints):
            return self._waypoints[self._current_index]
        return None

    def advance_waypoint(self) -> bool:
        """
        Advance to next waypoint.

        Returns:
            True if advanced to next waypoint, False if sequence complete
        """
        if self._current_index < len(self._waypoints) - 1:
            self._current_index += 1
            return True
        return False

    def reset(self):
        """Reset to first waypoint."""
        self._current_index = 0

    def is_complete(self) -> bool:
        """Check if all waypoints have been visited."""
        return self._current_index >= len(self._waypoints)

    @property
    def total_waypoints(self) -> int:
        """Total number of waypoints."""
        return len(self._waypoints)

    @property
    def current_index(self) -> int:
        """Current waypoint index (0-based)."""
        return self._current_index
```

**config/mission.yaml:**
```yaml
# Mission waypoint configuration
# Coordinates in meters, depth positive down

mission:
  name: "demo_mission"
  arrival_radius: 1.0  # meters, horizontal
  depth_tolerance: 0.5  # meters, vertical
  cruise_velocity: 0.3  # m/s
  cruise_depth: 3.0  # meters

waypoints:
  - {x: 5.0, y: 0.0, depth: 3.0, name: "WP1"}
  - {x: 5.0, y: 5.0, depth: 3.0, name: "WP2"}
  - {x: 0.0, y: 5.0, depth: 3.0, name: "WP3"}
```
  </action>
  <verify>python3 -c "from auv_planner.waypoint_manager import WaypointManager; wm = WaypointManager(); print('OK')"</verify>
  <done>WaypointManager class implemented with YAML loading and waypoint tracking</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Package structure exists: src/auv_planner/package.xml, setup.py
- [ ] Navigation utilities importable: `python3 -c "from auv_planner.navigation_utils import *"`
- [ ] WaypointManager importable: `python3 -c "from auv_planner.waypoint_manager import WaypointManager"`
- [ ] Mission config exists: src/auv_planner/config/mission.yaml
</verification>

<success_criteria>
- All tasks completed
- Python package structure valid
- Navigation utilities compute heading/distance correctly
- WaypointManager loads waypoints from YAML
- No import errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-planning/04-01-SUMMARY.md`
</output>
