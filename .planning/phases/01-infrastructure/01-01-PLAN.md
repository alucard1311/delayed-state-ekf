---
phase: 01-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [Dockerfile, docker-compose.yml, .env.example, scripts/docker-run.sh]
autonomous: true

must_haves:
  truths:
    - "Docker container builds without errors"
    - "Container can access GPU for OpenGL rendering"
    - "X11 forwarding configured for display output"
  artifacts:
    - path: "Dockerfile"
      provides: "ROS2 Humble + Stonefish build environment"
      contains: "FROM osrf/ros:humble-desktop"
    - path: "docker-compose.yml"
      provides: "Container orchestration with X11 and GPU"
      contains: "DISPLAY"
    - path: "scripts/docker-run.sh"
      provides: "Convenience script for container launch"
  key_links:
    - from: "docker-compose.yml"
      to: "Dockerfile"
      via: "build context"
      pattern: "build:"
---

<objective>
Create Docker infrastructure for Stonefish ROS2 simulation environment.

Purpose: Containerized, reproducible simulation environment that runs on any Linux system with Docker and GPU.
Output: Dockerfile, docker-compose.yml, and helper scripts for building and running the simulation container.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Research findings:
- Stonefish ROS2 package: https://github.com/patrykcieslak/stonefish_ros2
- Documentation: https://stonefish-ros2.readthedocs.io/
- Base image: osrf/ros:humble-desktop
- Requires OpenGL 4.3+ GPU
- X11 forwarding via /tmp/.X11-unix volume mount + DISPLAY env var
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile for ROS2 Humble + Stonefish</name>
  <files>Dockerfile</files>
  <action>
Create multi-stage Dockerfile:

1. Base: FROM osrf/ros:humble-desktop
2. Install Stonefish dependencies:
   - libglm-dev, libsdl2-dev, libfreetype6-dev
   - libgl1-mesa-dev, libopengl-dev
   - libx11-dev, libxrandr-dev
3. Clone and build Stonefish library from source (patrykcieslak/stonefish)
4. Set up ROS2 workspace at /ros2_ws
5. Clone stonefish_ros2 package
6. Build workspace with colcon
7. Set entrypoint to source ROS2 setup and run bash

Use ARG for Stonefish version tag (default: latest stable).
Include LABEL for maintainer and description.
Do NOT use sudo inside container (already root).
  </action>
  <verify>docker build -t stonefish-auv:latest . completes without errors</verify>
  <done>Dockerfile builds successfully, produces stonefish-auv:latest image</done>
</task>

<task type="auto">
  <name>Task 2: Create docker-compose.yml with X11 and GPU support</name>
  <files>docker-compose.yml, .env.example</files>
  <action>
Create docker-compose.yml with:

1. Service named "stonefish" using build context
2. X11 forwarding configuration:
   - environment: DISPLAY=${DISPLAY}
   - volumes: /tmp/.X11-unix:/tmp/.X11-unix:rw
   - volumes: ${XAUTHORITY:-$HOME/.Xauthority}:/root/.Xauthority:rw
3. GPU access (NVIDIA):
   - deploy.resources.reservations.devices with driver: nvidia, capabilities: [gpu]
   - OR runtime: nvidia (for older docker-compose)
4. network_mode: host (simplifies ROS2 DDS discovery)
5. ipc: host (for shared memory)
6. privileged: true (for GPU access)
7. Volume mount for workspace: ./src:/ros2_ws/src:rw

Create .env.example with:
- DISPLAY=${DISPLAY}
- Instructions for xhost +local:docker

Do NOT include QT_X11_NO_MITSHM=1 unless Qt issues arise (can cause other problems).
  </action>
  <verify>docker-compose config validates without errors</verify>
  <done>docker-compose.yml is valid, .env.example documents required setup</done>
</task>

<task type="auto">
  <name>Task 3: Create helper scripts</name>
  <files>scripts/docker-run.sh, scripts/docker-build.sh</files>
  <action>
Create scripts/ directory with:

1. docker-build.sh:
   - #!/bin/bash
   - docker-compose build --no-cache (optional flag)
   - Print success message

2. docker-run.sh:
   - #!/bin/bash
   - Check if xhost allows local docker: xhost +local:docker
   - docker-compose up (with optional -d flag)
   - Print access instructions

Make scripts executable (chmod +x).
Add comments explaining what each section does.
Use set -e for fail-fast behavior.
  </action>
  <verify>ls -la scripts/ shows executable scripts, shellcheck passes (if available)</verify>
  <done>Helper scripts created and executable</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] docker build -t stonefish-auv:latest . succeeds
- [ ] docker-compose config shows valid configuration
- [ ] scripts/docker-build.sh is executable
- [ ] scripts/docker-run.sh is executable
</verification>

<success_criteria>
- All tasks completed
- Dockerfile builds without errors
- docker-compose.yml validates
- Helper scripts are executable
- No hardcoded paths (uses environment variables)
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-01-SUMMARY.md`
</output>
