---
phase: 01-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: [src/auv_sim/package.xml, src/auv_sim/CMakeLists.txt, src/auv_sim/launch/simulation.launch.py, src/auv_sim/config/simulation.yaml, src/auv_sim/description/auv.xml]
autonomous: false

must_haves:
  truths:
    - "ROS2 package structure follows conventions"
    - "Launch file starts Stonefish simulator"
    - "Stonefish visualization window appears"
    - "ROS2 topics are published by simulator"
  artifacts:
    - path: "src/auv_sim/package.xml"
      provides: "ROS2 package manifest"
      contains: "stonefish_ros2"
    - path: "src/auv_sim/launch/simulation.launch.py"
      provides: "Launch file for simulation"
      contains: "IncludeLaunchDescription"
    - path: "src/auv_sim/description/auv.xml"
      provides: "Stonefish scenario definition"
      contains: "scenario"
  key_links:
    - from: "simulation.launch.py"
      to: "stonefish_ros2"
      via: "include launch"
      pattern: "stonefish"
    - from: "simulation.launch.py"
      to: "auv.xml"
      via: "scenario file parameter"
      pattern: "scenario_desc"
---

<objective>
Create ROS2 workspace structure and launch Stonefish simulation.

Purpose: Working ROS2 package that launches Stonefish simulator with a basic AUV scenario.
Output: ROS2 package with launch file, scenario description, and verified simulation startup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure/01-01-SUMMARY.md

Stonefish ROS2 documentation: https://stonefish-ros2.readthedocs.io/
- stonefish_simulator node requires scenario_desc and simulation_data paths
- Scenario XML defines environment, robot, sensors, actuators
- Use stonefish_simulator.launch.py as base
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ROS2 package structure</name>
  <files>src/auv_sim/package.xml, src/auv_sim/CMakeLists.txt, src/auv_sim/setup.py</files>
  <action>
Create src/auv_sim/ package with:

1. package.xml:
   - Package name: auv_sim
   - Build type: ament_cmake (hybrid for launch files)
   - Dependencies: rclcpp, rclpy, stonefish_ros2, std_msgs, geometry_msgs, sensor_msgs
   - exec_depend on stonefish_ros2

2. CMakeLists.txt:
   - Minimum cmake 3.8
   - find_package for ament_cmake, rclcpp
   - Install launch/, config/, description/ directories
   - ament_package()

Create directories: launch/, config/, description/

Do NOT use ament_python (keep it simple with ament_cmake for now).
  </action>
  <verify>Package structure exists with package.xml and CMakeLists.txt</verify>
  <done>Valid ROS2 package structure created</done>
</task>

<task type="auto">
  <name>Task 2: Create Stonefish scenario description</name>
  <files>src/auv_sim/description/auv.xml, src/auv_sim/description/materials.xml</files>
  <action>
Create minimal Stonefish scenario XML:

1. auv.xml (main scenario):
   - Environment: underwater with water surface at z=0
   - Ocean current: none initially (can add later)
   - Light source: sun from above
   - Robot: simple AUV body
     - Hull: cylindrical body (length ~1.5m, radius ~0.15m)
     - Thrusters: 4x thrusters for 4-DOF control (surge, heave, yaw, sway)
     - Sensors placeholder: DVL, IMU, depth (to be wired in Phase 2)
   - World origin at (0, 0, -5) to start underwater

2. materials.xml (referenced by auv.xml):
   - Basic material definitions for hull
   - Water properties

Use Stonefish XML schema from documentation.
Keep geometry simple - focus on getting simulation running.
Do NOT add complex hydrodynamics yet (Phase 2-3 concern).
  </action>
  <verify>XML files are well-formed (xmllint if available)</verify>
  <done>Stonefish scenario XML files created</done>
</task>

<task type="auto">
  <name>Task 3: Create launch file</name>
  <files>src/auv_sim/launch/simulation.launch.py, src/auv_sim/config/simulation.yaml</files>
  <action>
Create ROS2 launch file:

1. simulation.launch.py:
   - Import LaunchDescription, Node, IncludeLaunchDescription
   - Include stonefish_ros2 stonefish_simulator.launch.py
   - Pass parameters:
     - scenario_desc: path to auv.xml
     - simulation_data: path to Stonefish data directory
     - simulation_rate: 100.0 (Hz)
     - graphics_quality: "medium" (balance performance/visuals)
   - Use get_package_share_directory for paths

2. simulation.yaml (optional params):
   - simulation_rate: 100.0
   - graphics_quality: "medium"
   - window_width: 1280
   - window_height: 720

Follow ROS2 Humble launch file conventions.
Use DeclareLaunchArgument for configurable params.
  </action>
  <verify>ros2 launch auv_sim simulation.launch.py --show-args shows arguments</verify>
  <done>Launch file created and shows valid arguments</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Stonefish simulation environment with Docker, ROS2 package, and launch file</what-built>
  <how-to-verify>
    1. Run: xhost +local:docker (allow X11 access)
    2. Run: ./scripts/docker-build.sh (build container - this may take 10-15 min first time)
    3. Run: ./scripts/docker-run.sh (start container)
    4. Inside container: colcon build --packages-select auv_sim
    5. Inside container: source install/setup.bash
    6. Inside container: ros2 launch auv_sim simulation.launch.py
    7. Verify: Stonefish window appears showing underwater scene
    8. Verify: ros2 topic list shows Stonefish topics (e.g., /stonefish/*)
  </how-to-verify>
  <resume-signal>Type "approved" if simulation runs, or describe issues encountered</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/auv_sim/package.xml exists and is valid
- [ ] src/auv_sim/description/auv.xml exists and is well-formed
- [ ] src/auv_sim/launch/simulation.launch.py exists
- [ ] Docker container builds successfully
- [ ] Stonefish visualization window appears (human verified)
- [ ] ROS2 topics are published (human verified)
</verification>

<success_criteria>
- All tasks completed
- ROS2 package builds with colcon
- Stonefish simulator launches and displays visualization
- ROS2 topics visible in ros2 topic list
- Human verified simulation runs correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure/01-02-SUMMARY.md`
</output>
