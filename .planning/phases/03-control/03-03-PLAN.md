---
phase: 03-control
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified: [src/auv_control/launch/control.launch.py, src/auv_control/config/control_params.yaml, src/auv_control/CMakeLists.txt]
autonomous: false

must_haves:
  truths:
    - "Control node launches with simulation"
    - "AUV holds commanded depth within ±0.5m"
    - "AUV holds commanded heading within ±5°"
    - "AUV maintains commanded velocity within ±0.1m/s"
  artifacts:
    - path: "src/auv_control/launch/control.launch.py"
      provides: "Launch file for control node"
      contains: "control_node"
    - path: "src/auv_control/config/control_params.yaml"
      provides: "Tunable PID parameters"
      contains: "depth_kp"
  key_links:
    - from: "control.launch.py"
      to: "control_node"
      via: "Node launch"
      pattern: "Node"
---

<objective>
Create launch file and verify controllers against simulation.

Purpose: Make controllers launchable and validate they meet CTRL-01, CTRL-02, CTRL-03 tolerances.
Output: Working control system that can be launched with simulation and verified by human.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-control/03-01-SUMMARY.md
@.planning/phases/03-control/03-02-SUMMARY.md

**Verification approach:**
1. Launch simulation + EKF + control
2. Send depth command (e.g., 3m) - AUV should dive and hold
3. Send heading command - AUV should turn and hold
4. Send velocity command - AUV should move forward at speed

**Tolerance requirements:**
- CTRL-01: Depth ±0.5m
- CTRL-02: Heading ±5° (0.087 rad)
- CTRL-03: Velocity ±0.1 m/s

**Command topics:**
- `/auv/cmd/depth` (std_msgs/Float64) - depth in meters
- `/auv/cmd/heading` (std_msgs/Float64) - heading in radians
- `/auv/cmd/velocity` (std_msgs/Float64) - velocity in m/s
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create launch file and parameters</name>
  <files>src/auv_control/launch/control.launch.py, src/auv_control/config/control_params.yaml, src/auv_control/CMakeLists.txt</files>
  <action>
Create directories: launch/, config/

Create control_params.yaml:
```yaml
control_node:
  ros__parameters:
    # Control rate
    control_rate: 50.0  # Hz

    # Depth PID gains (output: heave force, max ±50 N)
    depth_kp: 20.0
    depth_ki: 2.0
    depth_kd: 10.0

    # Heading PID gains (output: yaw force, max ±30 N)
    heading_kp: 15.0
    heading_ki: 1.0
    heading_kd: 5.0

    # Velocity PID gains (output: surge force, max ±100 N)
    velocity_kp: 50.0
    velocity_ki: 5.0
    velocity_kd: 10.0
```

Create control.launch.py:
```python
from launch import LaunchDescription
from launch_ros.actions import Node
from ament_index_python.packages import get_package_share_directory
import os

def generate_launch_description():
    pkg_dir = get_package_share_directory('auv_control')
    params_file = os.path.join(pkg_dir, 'config', 'control_params.yaml')

    return LaunchDescription([
        Node(
            package='auv_control',
            executable='control_node',
            name='control_node',
            output='screen',
            parameters=[params_file],
        )
    ])
```

Update CMakeLists.txt to install launch/ and config/ directories:
```cmake
install(DIRECTORY launch config
  DESTINATION share/${PROJECT_NAME}
)
```
  </action>
  <verify>ros2 launch auv_control control.launch.py --show-args shows parameters</verify>
  <done>Launch file created with configurable PID parameters</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete control system with depth, heading, and velocity PID controllers</what-built>
  <how-to-verify>
    1. Start simulation (in container):
       colcon build
       source install/setup.bash
       ros2 launch auv_sim simulation.launch.py

    2. In another terminal (in container), start EKF:
       source install/setup.bash
       ros2 launch auv_ekf ekf.launch.py

    3. In another terminal (in container), start control:
       source install/setup.bash
       ros2 launch auv_control control.launch.py

    4. Check topics are active:
       ros2 topic list | grep -E "(cmd|thruster)"
       Should see: /auv/cmd/depth, /auv/cmd/heading, /auv/cmd/velocity
                   /auv/thruster/surge, /auv/thruster/heave, etc.

    5. Test DEPTH control (CTRL-01):
       ros2 topic pub /auv/cmd/depth std_msgs/Float64 "{data: 3.0}" --once
       # AUV should dive to 3m and hold
       # Watch control_node output for state logging
       # After 10 seconds, depth should be within ±0.5m of 3.0

    6. Test HEADING control (CTRL-02):
       ros2 topic pub /auv/cmd/heading std_msgs/Float64 "{data: 1.57}" --once
       # AUV should turn to ~90° and hold
       # After 10 seconds, heading should be within ±0.087 rad of 1.57

    7. Test VELOCITY control (CTRL-03):
       ros2 topic pub /auv/cmd/velocity std_msgs/Float64 "{data: 0.5}" --once
       # AUV should accelerate to 0.5 m/s
       # After 10 seconds, velocity should be within ±0.1 m/s of 0.5

    8. Verify combined behavior:
       # All three controllers should work together
       # AUV maintains depth while moving forward
       # No oscillation or instability

    9. (Optional) If unstable, adjust PID gains in control_params.yaml:
       # Reduce kp if oscillating
       # Reduce kd if jerky
       # Increase ki if steady-state error
  </how-to-verify>
  <resume-signal>Type "approved" if controllers meet tolerances, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] colcon build --packages-select auv_control succeeds
- [ ] Launch file works: ros2 launch auv_control control.launch.py
- [ ] Depth controller holds within ±0.5m
- [ ] Heading controller holds within ±5°
- [ ] Velocity controller holds within ±0.1 m/s
- [ ] Human verified all controllers work
</verification>

<success_criteria>
- All tasks completed
- Launch file and parameters work
- Depth hold verified (CTRL-01)
- Heading hold verified (CTRL-02)
- Velocity hold verified (CTRL-03)
- Human approved controller performance
</success_criteria>

<output>
After completion, create `.planning/phases/03-control/03-03-SUMMARY.md`
</output>
