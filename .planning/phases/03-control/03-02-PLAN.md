---
phase: 03-control
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [src/auv_control/include/auv_control/control_node.hpp, src/auv_control/src/control_node.cpp]
autonomous: true

must_haves:
  truths:
    - "Depth controller commands heave thruster based on depth error"
    - "Heading controller commands yaw thrusters with angle wrapping"
    - "Velocity controller commands surge thruster based on speed error"
  artifacts:
    - path: "src/auv_control/src/control_node.cpp"
      provides: "Three PID controllers for depth, heading, velocity"
      contains: "depth_pid_"
  key_links:
    - from: "control_node.cpp"
      to: "/auv/thruster/heave"
      via: "ROS2 publisher after depth PID"
      pattern: "heave_pub_->publish"
    - from: "control_node.cpp"
      to: "/auv/thruster/surge"
      via: "ROS2 publisher after velocity PID"
      pattern: "surge_pub_->publish"
---

<objective>
Implement depth, heading, and velocity PID controllers in the control node.

Purpose: Complete control system for AUV - depth hold, heading hold, and velocity regulation satisfying CTRL-01, CTRL-02, CTRL-03.
Output: Control node with three working PID controllers publishing to thrusters.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-control/03-01-SUMMARY.md

**Control requirements:**
- CTRL-01: Depth within ±0.5m
- CTRL-02: Heading within ±5° (0.087 rad)
- CTRL-03: Velocity within ±0.1 m/s

**Thruster limits (from auv.xml):**
- Heave: ±50 N
- Yaw bow/stern: ±30 N each
- Surge: ±100 N

**NED frame convention:**
- Positive Z is DOWN (depth increases downward)
- Positive heave force moves AUV down
- Yaw increases counterclockwise when viewed from above

**Angle wrapping:**
Heading error must wrap to [-π, π] to avoid spinning 270° instead of turning 90°.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PID controllers and parameters to control node</name>
  <files>src/auv_control/include/auv_control/control_node.hpp, src/auv_control/src/control_node.cpp</files>
  <action>
Update control_node.hpp to add:
- Three PID controller instances: depth_pid_, heading_pid_, velocity_pid_
- Control enable flags: depth_control_enabled_, heading_control_enabled_, velocity_control_enabled_
- Last control time for dt calculation

Update control_node.cpp constructor:

1. Declare parameters with defaults:
```cpp
// Depth PID gains
this->declare_parameter("depth_kp", 20.0);
this->declare_parameter("depth_ki", 2.0);
this->declare_parameter("depth_kd", 10.0);

// Heading PID gains
this->declare_parameter("heading_kp", 15.0);
this->declare_parameter("heading_ki", 1.0);
this->declare_parameter("heading_kd", 5.0);

// Velocity PID gains
this->declare_parameter("velocity_kp", 50.0);
this->declare_parameter("velocity_ki", 5.0);
this->declare_parameter("velocity_kd", 10.0);

// Control rate
this->declare_parameter("control_rate", 50.0);
```

2. Get parameters and create PID controllers:
```cpp
double depth_kp = this->get_parameter("depth_kp").as_double();
// ... etc for all gains

depth_pid_ = std::make_unique<PID>(depth_kp, depth_ki, depth_kd, 50.0, 25.0);
heading_pid_ = std::make_unique<PID>(heading_kp, heading_ki, heading_kd, 30.0, 15.0);
velocity_pid_ = std::make_unique<PID>(velocity_kp, velocity_ki, velocity_kd, 100.0, 50.0);
```

Max outputs match thruster limits. Max integral is half of max output for anti-windup.

3. Initialize control enables to true (active by default)

4. Add helper function wrapAngle(angle) to normalize to [-π, π]:
```cpp
double ControlNode::wrapAngle(double angle) {
  while (angle > M_PI) angle -= 2.0 * M_PI;
  while (angle < -M_PI) angle += 2.0 * M_PI;
  return angle;
}
```
  </action>
  <verify>colcon build --packages-select auv_control compiles without errors</verify>
  <done>PID controllers created with configurable parameters</done>
</task>

<task type="auto">
  <name>Task 2: Implement controlLoop with all three controllers</name>
  <files>src/auv_control/src/control_node.cpp</files>
  <action>
Implement the full controlLoop() function:

```cpp
void ControlNode::controlLoop() {
  // Skip if no EKF data yet
  if (!ekf_received_) {
    return;
  }

  // Calculate dt
  auto now = this->now();
  double dt = (now - last_control_time_).seconds();
  last_control_time_ = now;

  // Skip on first run or if dt is invalid
  if (dt <= 0.0 || dt > 1.0) {
    return;
  }

  std_msgs::msg::Float64 msg;

  // ===== DEPTH CONTROL (Z → heave) =====
  if (depth_control_enabled_) {
    // Error: positive when we need to go deeper
    // In NED: positive Z is down, positive heave force pushes down
    double depth_error = target_depth_ - current_depth_;
    double heave_cmd = depth_pid_->compute(depth_error, dt);

    msg.data = heave_cmd;
    heave_pub_->publish(msg);
  }

  // ===== HEADING CONTROL (yaw → yaw_bow, yaw_stern) =====
  if (heading_control_enabled_) {
    // Error with angle wrapping
    double heading_error = wrapAngle(target_heading_ - current_heading_);
    double yaw_cmd = heading_pid_->compute(heading_error, dt);

    // Bow and stern thrusters work together for pure yaw
    // Bow pushes one way, stern pushes opposite (stern is inverted in XML)
    // So we send same command to both
    msg.data = yaw_cmd;
    yaw_bow_pub_->publish(msg);
    yaw_stern_pub_->publish(msg);
  }

  // ===== VELOCITY CONTROL (vx → surge) =====
  if (velocity_control_enabled_) {
    double velocity_error = target_velocity_ - current_velocity_;
    double surge_cmd = velocity_pid_->compute(velocity_error, dt);

    msg.data = surge_cmd;
    surge_pub_->publish(msg);
  }

  // Log state periodically (every 50 cycles = 1 second)
  static int log_counter = 0;
  if (++log_counter >= 50) {
    log_counter = 0;
    RCLCPP_INFO(this->get_logger(),
      "State: depth=%.2f (target=%.2f), heading=%.2f (target=%.2f), vel=%.2f (target=%.2f)",
      current_depth_, target_depth_,
      current_heading_, target_heading_,
      current_velocity_, target_velocity_);
  }
}
```

Important notes:
1. Depth error sign: positive error means we're shallower than target, need positive heave (push down)
2. Heading uses angle wrapping to handle ±π discontinuity
3. Yaw thrusters: bow at +0.5m, stern at -0.5m, stern is inverted in XML
   - Sending positive command to both creates counterclockwise torque (positive yaw)
4. Sway thruster is not used (lateral motion not controlled in this phase)
  </action>
  <verify>colcon build --packages-select auv_control compiles without errors</verify>
  <done>Control loop computes PID outputs and publishes to thrusters</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] colcon build --packages-select auv_control succeeds
- [ ] Depth controller computes error and outputs to heave
- [ ] Heading controller wraps angle and outputs to yaw thrusters
- [ ] Velocity controller outputs to surge thruster
</verification>

<success_criteria>
- All tasks completed
- Three PID controllers implemented
- Angle wrapping handles heading discontinuity
- All thruster commands published
- Periodic state logging for debugging
</success_criteria>

<output>
After completion, create `.planning/phases/03-control/03-02-SUMMARY.md`
</output>
